<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
     <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />

    <style>
        
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f4f6f9;
      color: #212529;
      transition: background-color 0.3s, color 0.3s;
    }
    .navbar {
      background-color: #6f42c1;
      transition: background-color 0.3s;
    }
    .navbar a, .navbar-brand {
      color: #fff;
      transition: color 0.3s;
    }
    .navbar a:hover {
      color: #ddd;
    }
    .btn-toggle {
      cursor: pointer;
      background-color: transparent;
      border: 2px solid #fff;
      color: #fff;
      border-radius: 20px;
      padding: 5px 12px;
      font-size: 0.9rem;
      transition: all 0.3s;
      user-select: none;
      margin-left: 1rem;
    }
    .btn-toggle:hover {
      background-color: rgba(255,255,255,0.2);
    }

    .stat-card {
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 20px;
      text-align: center;
      background: white;
      transition: background-color 0.3s, color 0.3s;
    }
    .stat-number {
      font-size: 3rem;
      font-weight: 700;
      color: #6f42c1;
    }
    .stat-label {
      font-size: 1.2rem;
      color: #555;
    }

    /* Dark mode styles */
    body.dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }
    body.dark-mode .navbar {
      background-color: #4b2e91;
    }
    body.dark-mode .navbar a, body.dark-mode .navbar .navbar-brand {
      color: #ddd;
    }
    body.dark-mode .navbar a:hover {
      color: #fff;
    }
    body.dark-mode .btn-toggle {
      border-color: #ddd;
      color: #ddd;
    }
    body.dark-mode .btn-toggle:hover {
      background-color: rgba(255,255,255,0.1);
    }
    body.dark-mode .stat-card {
      background-color: #1e1e1e;
      color: #ddd;
      box-shadow: 0 4px 12px rgba(0,0,0,0.7);
    }
    body.dark-mode .stat-number {
      color: #bb86fc;
    }
    body.dark-mode .stat-label {
      color: #aaa;
    }

    /* DataTables dark mode overrides */
    body.dark-mode table.dataTable {
      color: #ddd;
      background-color: #1e1e1e;
    }
    body.dark-mode table.dataTable thead {
      background-color: #333;
    }
    body.dark-mode table.dataTable thead th {
      color: #ddd;
    }
    body.dark-mode table.dataTable tbody tr {
      background-color: #222;
    }
    body.dark-mode table.dataTable tbody tr:hover {
      background-color: #333;
    }
    body.dark-mode .dataTables_wrapper .dataTables_paginate .paginate_button {
      color: #ddd !important;
      background: none !important;
      border: none !important;
    }
    body.dark-mode .dataTables_wrapper .dataTables_paginate .paginate_button.current {
      background-color: #6f42c1 !important;
      color: white !important;
    }


    </style>




</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">Mer-Store</a>
            <div class="d-flex align-items-center">
                <a href="products.html">Back to store</a>
                <button class="btn btn-toggle" id="darkModeToggle">ðŸŒ™</button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>Dashboard</h2>
        <div class="row my-4 g-4">
            <div class="col-md-4">
                <div class="stat-card">
                    <div id="total-products" class="stat-number">0
                    </div>
                    <div class="stat-label">Total Products Fetched</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div id="items-cart" class="stat-number">0</div>
                    <div class="stat-label">Items in Cart</div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="stat-card">
                    <div id="quantity-cart" class="stat-number">0</div>
                    <div class="stat-label">Total Quantity in Cart</div>

                </div>
            </div>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <canvas id="lineChart" height="200"></canvas>
            </div>
            <div class="col-md-4">
                <canvas id="pieChart"></canvas>
            </div>
            <div class="col-md-4">
                <canvas id="barChart" height="200"></canvas>
            </div>
        </div>

        <h3>Cart Products Table</h3>
        <table id="cartTable" class="display stripe hover" style="width:100%">
            <thead>
                <tr>
                    <th>Product Name</th>
                    <th>Quantity</th>
                    <th>Price ($)</th>
                </tr>
            </thead>
            <tbody>

            </tbody>
        </table>

    </div>
    

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


      <script>
    const apiURL = 'https://dummyjson.com/products?limit=100';
    let allProducts = [];
    let dataTable = null;
    let charts = [];

    // Load dark mode preference
    function loadDarkMode() {
      if (localStorage.getItem('darkMode') === 'enabled') {
        document.body.classList.add('dark-mode');
      } else {
        document.body.classList.remove('dark-mode');
      }
    }

    // Toggle dark mode and save preference
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      if(document.body.classList.contains('dark-mode')) {
        localStorage.setItem('darkMode', 'enabled');
      } else {
        localStorage.setItem('darkMode', 'disabled');
      }
      updateChartColors();
    }

    function fetchProducts() {
      return fetch(apiURL)
        .then(res => res.json())
        .then(data => {
          allProducts = data.products;
          return allProducts.length;
        });
    }

    function updateDashboardStats(totalProducts, cartItems, totalQuantity) {
      animateCount('total-products', totalProducts);
      animateCount('items-cart', cartItems);
      animateCount('quantity-cart', totalQuantity);
      renderCharts(totalProducts, cartItems, totalQuantity);
      populateTable();
    }

    function animateCount(id, target) {
      const elem = document.getElementById(id);
      let count = 0;
      const step = Math.ceil(target / 100);
      const interval = setInterval(() => {
        count += step;
        if (count >= target) {
          count = target;
          clearInterval(interval);
        }
        elem.innerText = count;
      }, 15);
    }

    function renderCharts(total, items, quantity) {
      // Destroy previous charts if exist
      charts.forEach(c => c.destroy());
      charts = [];

      const commonOptions = {
        responsive: true,
        plugins: {
          legend: { labels: { color: getComputedStyle(document.body).color } }
        },
        scales: {
          x: { ticks: { color: getComputedStyle(document.body).color } },
          y: { ticks: { color: getComputedStyle(document.body).color }, beginAtZero: true }
        }
      };

      const lineCtx = document.getElementById('lineChart').getContext('2d');
      charts.push(new Chart(lineCtx, {
        type: 'line',
        data: {
          labels: ['Total Products', 'Items in Cart', 'Quantity'],
          datasets: [{
            label: 'Stats',
            data: [total, items, quantity],
            fill: true,
            backgroundColor: 'rgba(111, 66, 193, 0.2)',
            borderColor: '#6f42c1',
            tension: 0.4,
          }]
        },
        options: commonOptions
      }));

      const pieCtx = document.getElementById('pieChart').getContext('2d');
      charts.push(new Chart(pieCtx, {
        type: 'pie',
        data: {
          labels: ['Total Products', 'Items in Cart', 'Quantity'],
          datasets: [{
            data: [total, items, quantity],
            backgroundColor: ['#6f42c1', '#20c997', '#ffc107']
          }]
        },
        options: {
          plugins: {
            legend: { labels: { color: getComputedStyle(document.body).color } }
          }
        }
      }));

      const barCtx = document.getElementById('barChart').getContext('2d');
      charts.push(new Chart(barCtx, {
        type: 'bar',
        data: {
          labels: ['Total Products', 'Items in Cart', 'Quantity'],
          datasets: [{
            label: 'Stats',
            data: [total, items, quantity],
            backgroundColor: ['#6f42c1', '#20c997', '#ffc107']
          }]
        },
        options: commonOptions
      }));
    }

    function populateTable() {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];

      // Aggregate quantities by product id
      const cartMap = new Map();
      for (const item of cart) {
        if (cartMap.has(item.id)) {
          cartMap.get(item.id).quantity += item.quantity;
        } else {
          cartMap.set(item.id, { ...item }); // clone
        }
      }

      const cartAggregated = Array.from(cartMap.values());

      // Destroy existing DataTable if exists before recreating
      if(dataTable) {
        dataTable.clear().destroy();
        dataTable = null;
      }

      const tbody = document.querySelector('#cartTable tbody');
      tbody.innerHTML = '';
      cartAggregated.forEach(({ title, quantity, price }) => {
        tbody.innerHTML += `
          <tr>
            <td>${title}</td>
            <td>${quantity}</td>
            <td>${price.toFixed(2)}</td>
          </tr>
        `;
      });

      dataTable = $('#cartTable').DataTable({
        paging: true,
        searching: true,
        info: true,
        lengthChange: false,
        order: [[0, 'asc']],
        language: {
          search: "Search Products:",
          info: "Showing _START_ to _END_ of _TOTAL_ products"
        }
      });
    }

    // Update charts colors after dark mode toggle
    function updateChartColors() {
      charts.forEach(chart => {
        chart.options.plugins.legend.labels.color = getComputedStyle(document.body).color;
        if(chart.options.scales) {
          chart.options.scales.x.ticks.color = getComputedStyle(document.body).color;
          chart.options.scales.y.ticks.color = getComputedStyle(document.body).color;
        }
        chart.update();
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      loadDarkMode();

      document.getElementById('darkModeToggle').addEventListener('click', () => {
        toggleDarkMode();
      });

      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const totalProducts = await fetchProducts();
      const cartItems = cart.length;
      const totalQuantity = cart.reduce((acc, i) => acc + i.quantity, 0);

      updateDashboardStats(totalProducts, cartItems, totalQuantity);
    });
  </script>






</body>
</html>